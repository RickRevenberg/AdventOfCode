namespace AdventOfCode._2021
{
	using System;
	using System.Collections.Generic;
	using System.Linq;
	using NUnit.Framework;

	[TestFixture]
    public class Day_15
    {
	    private int gridWidth;
	    private Dictionary<int, Node> NodeDict;

	    [TestCase(1, TestName = "PartOne")]
	    [TestCase(5, TestName = "PartTwo")]
	    public void Solution(int dimensionMultiplier)
	    {
			ParseInput(dimensionMultiplier);

		    var answer = CalculateBestRouteScore();
		    Assert.Pass(answer.ToString());
	    }

	    private void ParseInput(int dimensionMultiplier)
	    {
		    var rows = Input.Split("\r\n").ToList();
		    gridWidth = rows.First().Length * dimensionMultiplier;

		    for (var i = 0; i < rows.Count; i++)
		    {
			    var newRow = rows[i];
			    var previousSection = rows[i];

			    for (var j = 2; j <= dimensionMultiplier; j++)
			    {
				    var newSection = string.Join("", previousSection.ToCharArray().Select(c => int.Parse(c.ToString())).Select(x => Math.Max(1, (x + 1) % 10)));

				    newRow += newSection;
				    previousSection = newSection;
			    }

			    rows[i] = newRow;
		    }

		    var originalRowCount = rows.Count;
		    for (var i = rows.Count; i < originalRowCount * dimensionMultiplier; i++)
		    {
			    var previousRow = rows[i - originalRowCount];
			    var newRow = string.Join("", previousRow.ToCharArray().Select(c => int.Parse(c.ToString())).Select(x => Math.Max(1, (x + 1) % 10)));

			    rows.Add(newRow);
		    }

		    var nodes = rows
			    .SelectMany((row, y) => row
				    .ToCharArray()
				    .Select(c => int.Parse(c.ToString()))
				    .Select((n, x) => new Node
				    {
					    Id = (y * gridWidth) + x,
					    RiskLevel = n
				    })).ToList();

		    nodes.First().RouteCost = 0;
		    nodes.First().RiskLevel = 0;

		    nodes.ForEach(node =>
		    {
			    var left = node.Id % gridWidth != 0 ? node.Id - 1 : -1;
			    var top = node.Id > gridWidth ? node.Id - gridWidth : -1;
			    var right = (node.Id + 1) % gridWidth != 0 ? node.Id + 1 : -1;
			    var bottom = (node.Id + gridWidth) < nodes.Count ? node.Id + gridWidth : -1;

			    node.Connections = new List<int> { left, top, right, bottom }.Where(x => x != -1).ToList();
		    });

		    NodeDict = nodes.ToDictionary(x => x.Id);
	    }

		// O(n) aww yeah
	    private int CalculateBestRouteScore()
	    {
			var endId = NodeDict.Keys.Count - 1;
			var currentLeafs = new List<int> { 0 };

			while (currentLeafs.Any())
			{
				var newLeafs = new List<int>();
				foreach (var leafId in currentLeafs)
			    {
				    var leaf = NodeDict[leafId];
				    foreach (var newLeafId in leaf.Connections)
				    {
					    var newLeaf = NodeDict[newLeafId];
					    var cost = leaf.RouteCost + newLeaf.RiskLevel;

					    if (cost < newLeaf.RouteCost)
					    {
						    newLeaf.RouteCost = cost;

						    if (newLeafId != endId)
						    {
							    newLeafs.Add(newLeafId);
						    }
					    }
				    }
			    }

			    currentLeafs = newLeafs;
			}

		    return NodeDict[endId].RouteCost;
	    }

	    private class Node
	    {
		    internal int Id { get; set; }
		    internal int RiskLevel { get; set; }

		    internal int RouteCost { get; set; } = int.MaxValue;

		    internal List<int> Connections;

		    public override string ToString()
			{
				return $"{this.Id}: {this.RiskLevel} - {this.RouteCost}";
			}
	    }

	    private const string TestInput = @"1163751742
1381373672
2136511328
3694931569
7463417111
1319128137
1359912421
3125421639
1293138521
2311944581";
	    private const string Input = @"1219917144152175521192937532735222272149142113771132143147736143821412611744118289583116354731774896
2557512188918722129241527232426994127475524882192911212273111191198918793769715954435631918975113353
5148523873321627398918131496732819295119712179711821713519886567141523157142619551992311453629315192
9632263822975132424163835224215815892118427192363791212959143352271227157116392913928119722459511125
3185531228179249199132957128512117111252215481499141912134153119363486721329112488129931544281746943
6444131257861912212213566341547625318612947741947592216383971229498251819853114728336521972351727213
6119491432245199553227565792296746663122251697311779965288819515139517181957182294511562659256672111
4171583111313321126172811385811255321273232454216251182121721131484211131831222492993728891981971114
1341849511511242171164255384447912212224719734743691122834632315218249551449671182115252121111156181
1121112491757379637111862858819612765926153911965619342514253127318148225883471116411283421481483345
1167137612323494235488916856964241714189111237191123629184132141111145253521464198423217838223242512
4311612195114191713711476122347911218991144817112121211611193399913617171241119191358941941128724511
2123711542281113233832612196322232224151811634272257192329211311115581942712113212557511132196641138
1213849757651153121353111121622819181131276414791121199285198731447891282943722115918164451314891482
8452414871316392311777435436449543321181278443124146282942335735799416795143316673734922393215263431
1279122141849833212177412212838363622166617823729182112922111161453729411617138551811798732554949918
1249419231711833991175332636161189983115218158581538822611657182121479211193211938125232371429245361
1319258512511139586913231118441291591712823735497296423917382353927134296132251532517492181693411375
3525191191342199293611167759151664313711134582741267191119461121431366123241927264523633112827214271
9387118746621534231131157516179343324752261123871127136532194122712932711311169283228722736522371834
4773514993519731492815621358211411439197463211136622834191131692919839112122181453172122255696861725
3198931377211519252141913161796151721418913267284128732587818431983433989963478138411161529411442572
2261499111361913823877342734465371229822182162132411947122174411152929198117151833172327911496151286
1961496281554884563122217455413111211628441529812218185321989446486689759325931211447941121311212314
3897242126711516589731569241135932561698777441162448251991349531993617884911148182621295295122135611
2412811444213823453246272367143231179558517361221185171111342171325361145992297331819913259413111527
9611111926111324991251141139812726231992911859513889884411422919226713323221711295798927912283813619
9563121343236772122984113282397434332892136811221126115712291632516112269949177199243128132147287541
8111836813275591191867182961221351352186133971921336475946474313133263141973412912119126431488746929
1819173956922111422339121928412725813184246318863216182117297149338314431117222121391942333715414442
3555392111317621347223556715543171546344431881435581192481113191839943868211448112211874545221334171
2222739299125482136593114624843922229242828241722681491234612921121197412271122915951873118379932344
8894211352921451247112111832115887222164719188413154182176233121511325216772371748814217111971291441
1241119546122152111234315223196183447191811299123422311336244221352485349331293341114119632223634797
4637913139122613238169186977764211118113343332851211117171224779326113113921321619812743123318122412
2461337399253583154176111281131145124112913691774116211773211142599211377341692716467112811115121192
1153375721177212844436432531661238112449236334311651313321796596121211551711299261661929611861251898
4893154234747691512431996536141312369111759297162949119242173188691662292511328133924822414724191117
5211775126411114348121619292141499234125581151111113111149141278442371171172594946555112147652634299
5917442496111599898513259229261421311181591691652923111351675561542342955131564454586482191829212192
9865167621895314375711471159161159158313433712114124412212168279119321622991152764966122421479798231
6548332431327841911816143662519918911614913451327118181631211961151355726862969176165531631753248521
5122351829687371111443237234211291132275428173941122649496341219371168219125531141627511818841483129
3141533982287711251295246118381924133118191856944972112175571441512626962511223133726161425521149241
1821514936525118453193161518897576271879751936248147412942297553212947276421421999264129282438111231
6141863149146173593991157124416744781625932429378911421331232112247414988122711418587999129921221122
2895979246915111697386933211415182292171391339699351319296991249321449625463511311243334911121812412
9177815411963232141161419498192413849819511221131618249691181151221218142512512822221741292341241892
9819396217132198357912599619225141914974518191118289523187528714716116111413142941111222347936964419
7765213221824954389191123482488934933151372615399632117813129121643375133484515211794242186441632541
6951214213553792986255118522686218217292313176158411312115195111332671114991213236936519198143236111
9118287696282937591138441514192592117643231764197725942334257111713232715122281852399745911114271137
4566422611231133195134162897522357348143161728134311794135115211225351133121513783383214256277311532
4475393713114151182644171131852591421261492882128118319154692171421187171684511672619911172348164194
1111217799913661277119632571453317646718377991238132523827595949362221445516394911114115131363191811
7765812716992133119444669152192111667198133189233863123711311327383681188761121456592218131114819336
1388184462842955782412892223162192325251579369336785211348512617232196131228482959731138937157718498
1442281432432331243141181167352743261155331127154521914436339624135153921111991841222144349221983263
2118911111722128423435369234197632171161321332713739152981254534392116711212168748182558241119612292
7425835555999411456115219711486928871791194911622422443131131151869943793121849452757479151541193238
6273533932119332144337838911241924161952426152244282136613131931814413713937961331142348314112627681
3619382443482484922182198232111231252214976973134811171119137322129479818551912311199121291122162929
3912426218529951835351144327195139233117757188845988637711159522282848376115132711917168971451261518
3265925112111433392872328782961619171185173966152417141155325312131122616411333111238191716261257485
1242716431166513161625111114683932616217931984541184688911592972726739656935164145121145132631314979
3415492185254118831924313536616252481713116172113531691597114621371211158112161119334313826141379994
5441892282127311173977232233728731115776543922581812411399115488149292752192929319849273222151196922
1235743787531916112292489438144472231211658527293188711973137267112212211167314293171287136682955115
1333294722215132412221221262162219457229132119913516725252151338221919327451136911113112117336822515
9331231123592911822263353141831119975118161447142819761483517671116143433133142332512659131913222721
3992253114286291383443278312415738212511824722112142285454597529913218231311912211942471216196171264
7711342215218256815142128911292422371111121543424241292139213131665264611211251126121888119691522734
8411511211111416645747264431231945531421941991159321719191626986135153918923138823123521913311198361
6121728223451261313327971988476382228291893892961729321143199752834127947814918789111334173233399917
9313991119478121911791171414449229764818191131372312248732529637235133261912819111353262161311546151
6649929178412651913799572613826355481534259121496795338311425411595416142114438611896811513191294332
2132111122838179135732712817169152933112621182473182281571194352212917691913414532612228113172111358
2134222915341933394564321262512639111728333221919123218326614591155318825191435373754119826745581171
6742116731122431232352198412116792152911711441192111114918117431269171311433451923331143412222412131
7219269346518212476157254134997112325122255417321112617147112914699612443937121912819111166191791856
1291426781442111827269315611129912298472441375137133924961118112332121213446939299391382279288479832
5111286128131184229931541119389592147372869163918183417952918911352311258311537699525638569517633869
1359593994121893927658864372474592242416516361415129132114962419923181927917646131191196311617581293
1237169312421138451513332522714144374669422211691149331324891299921786471185594199159179126153974198
7138277991213181681291435176294846458821417597651324616721711192111269574424121725841217526321921113
2161711131191415119721833839443682513651341232156254241697172725136211433293118592564228291612193175
1727751123829611982619162593242155341421111359221311219161583917218119189643995635165131411717212478
3117829197616964164244562631312123353771267731191121111669399731835815516112513151252241917416362637
3194136151344178679113326751926511212592171651666551146418825317116834246251364323719111772313131587
4291217141757268211156428822859436947765174113615122993621171932855219161411491911134545431181711299
5997413363617522311289962152813138983337592831554436331449697411511331141919367112145863531983739525
4921956113922148983493293662286283931168581912293125191141141933921922555924248751397286198663591915
1215941691191215417121184719678595241271547449751274399115174111167841222943228823242831122511727131
1159182321242861312426534714612318674343111171114851259411791112329417724215297322521225512741224311
6281341219211943791368131121321267212256393218518218419131162114813236387812741163832532141821219916
4193245278439599314115597967195121393211954731119312111183627617215112219382729591791697152923521124
7271212528143433228925278813516213957172122199181859163721121116782941621321111232342127151299298258
1193171222181731577512311151622115325981249325524411329527149123294187131519331115293169191191188974
7361414488876111685422912712199945339791122321313661373284819524231223276991835456242151321911173365
6132116139116159519661211214183822195812917735711165919172937611282417713718496254611651115137154211";

	    private const string JoostInput = @"1947696975698896797929459993778378493663187915544561834986191836269969899167858897819699793994718987
2311559817927999719999597987189844226139358211239975663924921992997751999137989799783998666847189117
1398783175891937833687888598786896125883638881619291974159998891739786137969443961276399292284679298
1799975998227669996115794797677699798175616958417287499395295199789322764647852198997299659859389619
1739612118291539157254493162397155936981318995862379954635661973979239239969788818966686499766387398
8719671599693942744933141579913498448999942189769767769727796927818765883586697625896957338688939595
2796178218968711997834882837787524726852995959861184787996936352849434128388663893131285789869867179
1317915348335592621751989478997918859522948897849669839469818925318165648989686591857953378291512297
1917441697892979356516974994728598567293861181628838749943997155596868516192997995698976986999929371
5849994149999983668899666755471964957888827868382391818789668871178857186118299899984319718818547999
1858939984861235938958973189492499494194992452675713688286627988991934848921897684964578219133166893
5776439827541299259274198171669552698119771981281496128578196275168739222452299429369829811861496499
2931776597359576234168169379956899871919758688721864948334918341821841299995494661199995762869156991
6289867119753899419197123896818739991327589369298748196458376848925564912321896787819694349929839298
4997387711789873575455786193986389228961185892227229979178939244544847921296114415997191878689531627
8897817989689288875783994178238956724749794811386839271317691993557997889383197977991247644713122658
4813729998926163799795829927989966987647443825496186775588779436794595939819685969483895629779978994
9982381691182111249924694648195956274292964886651799679999461587916412391111914863298296939289519326
5518779882172129996799352736999989891351661978589977619474626595989979213281881181713962999638878749
1169143672568917918812189529673989891989319993181689616698876527476668229991785129399132957998293929
8932884767249667994824929985962599999446812717991922884965499769331385285883628677818991391979189591
9766631975919747512817886897999329888498273594543699991277687617365818493923416969949395683731666999
8689137997791238716357751996996932188896498564645962891656899188187886182198598949352147972939995981
8756667515181197779916113191699889768119499489778999982987198759665998771867182286475992682119989186
1124649829964624878299998991719216999531459818697398785544979997925391161972892999638319187263219291
9857974935269921914969318391941987992868999696658881799996369929596587999955211159959539834844838938
8919518179891539221114534928929998682984285713324169997579726187396989931396888199971975911197624343
4198999483679799381891316193673681916999839397617888964187992886961894398798991629876949216948895886
5192399967381999671189871735251138975778284959494189952999787338796649318699917846183585656874323596
1893214972385815928898851749895568669919679168894679448588489979936994294173766495171795996837279798
9925899897867776945988571695929419298879759819616189897989928981743763471116989379923999917866996988
7898189849949524777471266525684394299191312497519521975217389687694742133287697195338979526643967962
9615449115351624536799387998728899998781678539998641999545933534719891695719449897555887893629515822
9967782543998623985849896599999912897986696167296354329331689299784671929929891989669362197688839989
5967639211387841157996617492973348185229739299894428482889691838688742476486859868197983598966921825
7374376999914646846159231981424471219993689182736894895911492781597795948896794286911974218168959688
1996777211988193895413595213285949489968378779163387495998169499286948679138897132957778196186286879
8581565398788646998527126155638497989663368989725257857989562264976191159879979912849223699948128541
3599998922796929171999367932718549618454129935893613989956288834954647823429868649722282528769635169
7965999579595347289122479263497282984879518915648699638853761299869992425182816839951699576669738439
9497259397977683444889684985994631953896491966492184959179295719881915997916955981999124439848439919
9299184895781751297379927729227697885499115954722224199369169378989721498692828999492272998762926182
8899918997997499371887274979645481998679657997985273876598799769168969117892198614388378987917797485
8888639479899578581818994935127972889989716962616949248999484633993729811567929469229125921919195922
7412341947369985616487775891156912797213858175119775714813182782982441694221615772849179626271163979
9713899969178972587129996911977194578919896659891975573995285858147979997544523995539599519929954373
6977915961998959699139171198789946179721929991498551491999847478148232944999225846274848263749871969
7938429293718924342299994228859372817167111995691968294347997689992799383971648733721911178997296112
4718179195943598268197379998915778236975725765789985337768493125897931769569919116211139648687775539
3187169444859797746988567791165913976863864173975559773797411998489129397742123295741349118153954252
7743878683798777186899638785767783728999499991925419611637897819688137142944978799988422939887928872
9529716867483494769988271913447999618299718513193799548497329269976619887381213997945835119595149998
2119493423877341197391997989889828599881299199687322299193292396969114657449424183489412798998565996
8579268797199219755999277788599798198959989783926929897378971367634898793216982158621495661631646996
6381377477933896299924477362838647438119824946992939998353564984136993615423299987581558191799979519
4284948959891866211159982231989583128991667559619912479935821379597939998881793996672694751391685419
4271997567779892129695961889679529797699955298935611991393116929614329958133458557617126128737171975
8924279138787698771271599787383219399699878481218367439786486976729865875688999719974592891991931129
1968313888382783239491539891982969692611188184727363995581992416578489789999971887191895686866497961
6819682575973959978791722829899225893892198376185283982796625566898698248986788471994875177797286633
9987848869957999874963198739178572141271729926886697898157378897595998111491814996359777978135591911
8295753397299818884346189266465389842998289999978131417948287838948683275626697995786722885399714179
4159299297938377379499928398939358928119118498912227718798934986766315252625281777796575691241789157
1932549925919993995995496562798279994659989319749888713254969999598989919674989394958732958676463995
6516929358966191219219718536486198329523591968994882597281891198716816782728643297736984985991896791
9667699479375153511788876976916698889981985289355894998232798185556258115791517819499535167998448779
9182754699279987498847431286924977916798615881612933679988992599196459295988799917959819289939917357
5995185897223987369289994168735877289928918688486816695794378882617846797889119245831139989861169777
1919558599869961567591499919154298592898477398927649419859979599192511731998289569649669193569113849
4999946839545648998489891966649619198219798999999999914187151712276975396157763411169696498869957861
6289689397891392984985354697412929547898138862874899381561546592941246854928176476491796951999414774
5652838889814579419859281827997499845991343981287281999299378517918618996719949696298312496439778619
8398927129969385788911967691575591249119819485637541256534779912896664397798858922684487117588796791
7861849932949588973793868992958969291986221198819918596158567837435458346119946219376154498731588755
5493124289928195795516937184978949534987929879334213189453569461199679943999281876599997919794497891
9999289438489936768495687178923887113991426158815881798943621849679698865918385748747549198896945196
8329769676578863628791881283699954598381987222212959979488618852587529197619153796962699927717484239
9487296468769179278286959945169598513174655785739971473592952723691273674755969691937916991393346952
9411683765427277541128978945948779185769211693899298899969219797928988898587784915491518858848763988
4174999933693277496789136899128898432995597886796394298149458879355336792996641869734917699868828977
7828853373677139558387437918519944911824751833725979758971928474562189579766917561341888751644883128
9944957631796893189549142471959197819965859979874371592689845268979576141939919872799592796897681978
9129399759399864944997496561649469416722711829816839618967922198998944196191923796976124876598894711
1984651621989673719839789412249992689133656682689896115183298557783399663916359928184233859817826192
6747491896529965195479995582499576938291218158711891822699394479117975866839111928819987139962917979
5862897881242992991697478793791189884133668915997495392975899615191727919733914659972679523966971891
9989177777898175191124159959961821565185996187981771651916828189728186341115886299299282716795193914
8594917468798751791997499796918998296468668394472199718429631939161593978764875719457714959199328597
9971699893896568665199714839127299338839719637246871923899217816181864923749857618999197894993549475
7453732369719421164219599913199692119997885891788498915336679921979737838398149748219899989951721172
7795419181929159189156763936827178722398947294962661194194817349313848552459846299611933617899175511
6452998586858979994398825783449369926689988998317949118939599699399391489738115999949299784992548996
9558149995645639945478899819374918258599745978774328799577491834828698297964697221963783152673619218
1898846289739195946913361269877398668671669969831811232867623929582214121581877169678689911847611953
3389866271533776219379932895441898985239319472749732617688685138778937439175211298981167699614418877
5981952512941958193593448279411963515259361829919999916618896939551988188889799945993187694576962655
3381463186971948918531839533939811191699291588588992929191728587528918737888497916279526579853921937
2947186951912279898383973859526182194614259992831699857959715873216595149977719857546897969994566694
6599943861781981529974889474584753289169598547791967988964158798291811168499239339947159893217981248
9881729689387519626589799227787849951152391998437917592378789299389591999991829988849718719962682192";
    }
}
